---
import grilles from "../assets/grilles.webp";
import { getCompetencesByNames } from "../lib/pocketbase.mjs";

interface Props {
  projet: any;
}

const { projet } = Astro.props;

let stackCompetences: any[] = [];
if (projet.stacks && projet.stacks.length > 0) {
  try {
    console.log("Stacks reçus:", projet.stacks);
    stackCompetences = await getCompetencesByNames(projet.stacks);
    console.log("Compétences trouvées:", stackCompetences);
  } catch (err) {
    console.error("Erreur lors de la récupération des compétences :", err);
  }
} else {
  console.log("Pas de stacks:", projet.stacks);
}

const hasContent =
  (stackCompetences && stackCompetences.length > 0) ||
  projet.contraintes ||
  projet.approche ||
  projet.apprentissage;
---

{
  hasContent && (
    <section
      class="w-full h-fit bg-center bg-cover flex flex-col items-center py-12 sm:py-16 md:py-24 lg:py-32 px-3 sm:px-4 relative"
      id="developpement"
      style={`background-image: url(${grilles.src});`}
    >
      <h2 class="h2 relative z-10 text-center">
        &lt;LE <span class="text-primary">DÉVELOPPEMENT</span>&gt;
      </h2>
      <div
        class="max-w-7xl gap-4 md:gap-5 lg:gap-6 mt-6 sm:mt-8 md:mt-10 lg:mt-12 px-4 relative z-10 w-full"
        style={`
          display: flex;
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
          @media (min-width: 1024px) {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: stretch;
          }
        `}
      >
        {stackCompetences.length > 0 && (
          <div
            class="flex flex-col gap-4 md:gap-5 lg:gap-6 h-full w-full"
            style={`
              display: grid;
              grid-template-columns: repeat(${
                stackCompetences.length === 1
                  ? 1
                  : stackCompetences.length === 3
                    ? 2
                    : stackCompetences.length === 4
                      ? 2
                      : stackCompetences.length === 5 ||
                          stackCompetences.length === 7
                        ? 2
                        : stackCompetences.length === 6 ||
                            stackCompetences.length === 8
                          ? 2
                          : 2
              }, minmax(0, 1fr));
              gap: 1rem;
              width: 100%;
              align-items: stretch;
              auto-rows: 1fr;
              @media (min-width: 1024px) {
                width: fit-content;
                grid-template-columns: repeat(${
                  stackCompetences.length === 1
                    ? 1
                    : stackCompetences.length === 2
                      ? 1
                      : stackCompetences.length <= 4
                        ? 1
                        : 2
                }, 1fr);
                height: 100%;
              }
            `}
          >
            {stackCompetences.map((comp, index) => {
              const length = stackCompetences.length;
              let colSpan = 1;
              let rowSpan = 1;

              // Logique mobile/tablette (< lg)
              if (length === 3) {
                if (index === 0) {
                  colSpan = 2;
                  rowSpan = 1;
                }
              } else if (length === 5) {
                if (index === 0) {
                  colSpan = 2;
                  rowSpan = 1;
                }
              } else if (length === 7) {
                if (index === 0) {
                  colSpan = 2;
                  rowSpan = 1;
                }
              }

              // Logique desktop (lg+) - à implémenter dans une media query
              return (
                <div
                  class={`w-full h-full rounded-2xl md:rounded-3xl relative border border-white/10 overflow-hidden flex flex-col items-center justify-center p-4 sm:p-5 md:p-6 min-h-[100px] md:min-h-[120px] transition-all duration-300 hover:shadow-lg bg-white`}
                  style={`
                    grid-column: span ${colSpan};
                    grid-row: span ${rowSpan};
                    @media (min-width: 1024px) {
                      grid-column: span 1;
                      grid-row: span 1;
                    }
                  `}
                >
                  <div class="w-full relative z-20 flex flex-col items-center justify-center gap-2 md:gap-3">
                    {comp.icone && (
                      <img
                        src={comp.icone}
                        alt={comp.nom}
                        loading="lazy"
                        class="w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 object-contain"
                        style="filter: brightness(0) saturate(100%) invert(24%) sepia(91%) saturate(2447%) hue-rotate(244deg) brightness(104%) contrast(97%);"
                      />
                    )}
                    <h4 class="h4 text-center line-clamp-2 text-primary">
                      {comp.nom}
                    </h4>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        <div class="w-full h-full flex flex-col gap-4 md:gap-5 lg:gap-6 justify-start">
          {projet.contraintes && (
            <div
              class="w-full flex-1 h-auto rounded-2xl md:rounded-3xl relative border border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.08),inset_-5px_-5px_15px_rgba(0,0,0,0.5)] overflow-hidden backdrop-blur-[50px]"
              style="background: radial-gradient(circle at center, rgba(53, 63, 82, 0.75) 0%, rgba(53, 63, 82, 0.75) 38%, rgba(45, 54, 71, 0.75) 100%);"
            >
              <div class="noise absolute inset-0" />
              <div class="absolute inset-0 pointer-events-none bg-linear-to-t from-black/60 to-transparent" />
              <div class="relative z-20 w-full h-full p-4 sm:p-5 md:p-6 lg:p-8 flex flex-col justify-start gap-2 sm:gap-3">
                <h3 class="h3">Contraintes</h3>
                <p class="leading-relaxed">{projet.contraintes}</p>
              </div>
            </div>
          )}

          {/* Apprentissage et Approche côte à côte */}
          {(projet.approche || projet.apprentissage) && (
            <div class="w-full flex-1 flex flex-col sm:flex-row gap-4 md:gap-5 lg:gap-6">
              {projet.approche && (
                <div
                  class="w-full sm:flex-1 h-full rounded-2xl md:rounded-3xl relative border border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.08),inset_-5px_-5px_15px_rgba(0,0,0,0.5)] overflow-hidden backdrop-blur-[50px] flex flex-col justify-start p-4 sm:p-5 md:p-6 lg:p-8 transition-all duration-300"
                  style="background: radial-gradient(circle at center, rgba(53, 63, 82, 0.75) 0%, rgba(53, 63, 82, 0.75) 38%, rgba(45, 54, 71, 0.75) 100%);"
                >
                  <div class="noise absolute inset-0" />
                  <div class="absolute inset-0 pointer-events-none bg-linear-to-t from-black/60 to-transparent" />
                  <div class="w-full relative z-20 flex flex-col justify-start gap-2 sm:gap-3">
                    <h3 class="h3">Approche</h3>
                    <p class="leading-relaxed">{projet.approche}</p>
                  </div>
                </div>
              )}

              {projet.apprentissage && (
                <div
                  class="w-full sm:flex-1 h-full rounded-2xl md:rounded-3xl relative border border-white/10 shadow-[0_0_30px_rgba(255,255,255,0.08),inset_-5px_-5px_15px_rgba(0,0,0,0.5)] overflow-hidden backdrop-blur-[50px] flex flex-col justify-start p-4 sm:p-5 md:p-6 lg:p-8 transition-all duration-300"
                  style="background: radial-gradient(circle at center, rgba(53, 63, 82, 0.75) 0%, rgba(53, 63, 82, 0.75) 38%, rgba(45, 54, 71, 0.75) 100%);"
                >
                  <div class="noise absolute inset-0" />
                  <div class="absolute inset-0 pointer-events-none bg-linear-to-t from-black/60 to-transparent" />
                  <div class="w-full relative z-20 flex flex-col justify-start gap-2 sm:gap-3">
                    <h3 class="h3">Apprentissage</h3>
                    <p class="leading-relaxed">{projet.apprentissage}</p>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </section>
  )
}
